---
- name: "foodsoft | Configure git safe.directory"
  ansible.builtin.command:
    cmd: " git config --global --add safe.directory {{ foodsoft_home }}"

- name: "foodsoft | get latest tag"
  ansible.builtin.shell:
    cmd: curl -sL "{{ foodsoft_git_latest_tag_url }}" | jq -r '.[0].name'
  register: latest_tag

- name: "foodsoft | clone repository"
  ansible.builtin.git:
    repo: "{{ foodsoft_git_url }}"
    dest: "{{ foodsoft_home }}"
    version: "{{ foodsoft_version }}"
    force: true

- name: "foodsoft | Ruby version lookup"
  ansible.builtin.shell: cat "{{ foodsoft_home }}/.ruby-version"
  register: ruby_version
  changed_when: false

- name: "foodsoft | change owner"
  ansible.builtin.file:
    path: "{{ foodsoft_home }}"
    state: directory
    recurse: true
    owner: "{{ foodsoft_user }}"
    group: "{{ foodsoft_user }}"

- name: "foodsoft | setup rbenv"
  ansible.builtin.lineinfile:
    path: "{{ foodsoft_user_home }}/.bashrc"
    line: eval "$(rbenv init -)"

- name: "foodsoft | create rbenv plugin directory"
  ansible.builtin.file:
    path: "{{ ruby_path }}/plugins"
    state: directory
    owner: "{{ foodsoft_user }}"
    group: "{{ foodsoft_user }}"
    mode: 0755

- name: "foodsoft | install ruby-build"
  ansible.builtin.git:
    repo: "{{ ruby_build_git_url }}"
    dest: "{{ ruby_path }}/plugins/ruby-build"
    version: master

- name: "foodsoft | install ruby"
  ansible.builtin.command:
    cmd: 'rbenv install {{ ruby_version.stdout }}'
    creates: "{{ ruby_path }}/versions/{{ ruby_version.stdout }}/bin/ruby"
  become: true
  become_user: "{{ foodsoft_user }}"

- name: "foodsoft | install bundler"
  ansible.builtin.command:
    cmd: rbenv exec gem install bundler
    chdir: "{{ foodsoft_home }}"
    creates: "{{ ruby_path }}/versions/{{ ruby_version.stdout }}/bin/bundler"
  become: true
  become_user: "{{ foodsoft_user }}"

# https://nokogiri.org/tutorials/installing_nokogiri.html#installing-using-standard-system-libraries
- name: "foodsoft | configure nokogiri"
  ansible.builtin.command:
    cmd: 'rbenv exec bundle config build.nokogiri "--use-system-libraries"'
    chdir: "{{ foodsoft_home }}"
  become: true
  become_user: "{{ foodsoft_user }}"
  environment:
    RAILS_ENV: production

- name: "foodsoft | set bundle options"
  ansible.builtin.command:
    cmd: "rbenv exec bundle config set --local without 'development test'"
    chdir: "{{ foodsoft_home }}"
    creates: "{{ foodsoft_home }}/.bundle/config"
  become: true
  become_user: "{{ foodsoft_user }}"

- name: "foodsoft | enable local Gemfile support"
  ansible.builtin.blockinfile:
    path: "{{ foodsoft_home }}/Gemfile"
    marker: "# {mark} ANSIBLE MANAGED BLOCK | local Gemfile support"
    block: |
      local_gemfile = File.join(File.dirname(__FILE__), "Gemfile.local")
      if File.exist?(local_gemfile)
        eval_gemfile local_gemfile
      end

- name: "foodsoft | copy Gemfile.local"
  ansible.builtin.copy:
    src: foodsoft/Gemfile.local
    dest: "{{ foodsoft_home }}/Gemfile.local"
    owner: "{{ foodsoft_user }}"
    group: "{{ foodsoft_user }}"
    mode: 0644

- name: "foodsoft | install ruby packages"
  ansible.builtin.command:
    cmd: "rbenv exec bundle install"
    chdir: "{{ foodsoft_home }}"
  become: true
  become_user: "{{ foodsoft_user }}"
  environment:
    RAILS_ENV: production

- name: "foodsoft | copy default configuration"
  ansible.builtin.copy:
    src: "{{ foodsoft_home }}/config/app_config.yml.SAMPLE"
    dest: "{{ foodsoft_home }}/config/app_config.yml"
    remote_src: true
    owner: "{{ foodsoft_user }}"
    group: "{{ foodsoft_user }}"
    mode: 0600
    force: false

- name: "foodsoft | copy Active Storage configuration"
  ansible.builtin.copy:
    src: "{{ foodsoft_home }}/config/storage.yml.SAMPLE"
    dest: "{{ foodsoft_home }}/config/storage.yml"
    remote_src: true
    owner: "{{ foodsoft_user }}"
    group: "{{ foodsoft_user }}"
    mode: 0600
    force: false

- name: "foodsoft | create Active Storage directory"
  ansible.builtin.file:
    path: "{{ foodsoft_home }}/storage"
    state: directory
    owner: "{{ foodsoft_user }}"
    group: "{{ foodsoft_user }}"
    mode: 0755

- name: "foodsoft | Add privileges to sharedlists suppliers"
  ansible.builtin.mysql_user:
    name: "{{ foodsoft_db_user }}"
    priv: sharedlists.suppliers:SELECT/sharedlists.articles:SELECT
    append_privs: true
    state: present
    login_unix_socket: "{{ mariadb_socket }}"
    login_user: root

- name: "foodsoft | Add logrotate configuration"
  ansible.builtin.template:
    src: logrotate.d/foodsoft.j2
    dest: /etc/logrotate.d/foodsoft
    mode: 0644
