---
- name: "webserver | add domain"
  lineinfile:
    path: /etc/dehydrated/domains.txt
    line: "{{ foodsoft_domain }}"
  register: add_domain
  when: "'dehydrated' in ansible_facts.packages"

- name: "webserver | create certificate"
  command: dehydrated --cron -g
  when: add_domain.changed

- name: "webserver | copy nginx sites"
  template:
    src: nginx.j2
    dest: "/etc/nginx/sites-available/{{ foodsoft_domain }}"

- name: "webserver | activate nginx site"
  file:
    src: "/etc/nginx/sites-available/{{ foodsoft_domain }}"
    dest: "/etc/nginx/sites-enabled/{{ foodsoft_domain }}"
    state: link
  notify: reload nginx

- name: "webserver | copy redirect file"
  copy:
    src: nginx/foodsoft_redirects.conf
    dest: /etc/nginx/snippets/foodsoft_redirects.conf
  notify: reload nginx